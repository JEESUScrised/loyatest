Backend для сервиса лояльности
===============================

Этот файл содержит информацию о бэкенде сервиса лояльности.

ВАЖНОЕ ПРАВИЛО РАЗРАБОТКИ:
==========================
Все изменения в бэкенде должны записываться в этот README файл.
Логика бэкенда должна быть структурирована и задокументирована.
Это правило используется постоянно при работе с проектом.

Планируемая функциональность:
- Управление пользователями
- Система баллов и наград
- API для мобильного приложения
- Административная панель

СТРУКТУРА БЭКЕНДА:
==================

СИСТЕМА ЛОЯЛЬНОСТИ ДЛЯ ЗАВЕДЕНИЙ СФЕРЫ ОБСЛУЖИВАНИЯ
==================================================
Целевые заведения: кофейни, кафе, рестораны, бары, салоны красоты и др.

ПЛАТФОРМА: Telegram Mini App
=============================
Пользователь попадает в приложение через Telegram бота.
Главный экран содержит:
- Баланс баллов пользователя
- Строка ввода для кода (QR код)
- Информация о сгорании баллов (количество и срок)

ЭНДПОИНТЫ ДЛЯ ПОЛЬЗОВАТЕЛЯ:
============================

GET /api/user/profile
- Получить профиль пользователя
- Возвращает баланс баллов, информацию о сгорании
- Требует аутентификации

POST /api/user/register
- Регистрация нового пользователя
- Принимает данные Telegram (id, username, first_name, last_name)
- Возвращает userId

POST /api/user/use-code
- Использование 6-значного кода покупки
- Принимает code (6 символов)
- Требует аутентификации
- Возвращает начисленные баллы

GET /api/user/check-code/:code
- Проверка статуса кода
- Возвращает время жизни и количество баллов
- Не требует аутентификации

GET /api/user/points-history
- История операций с баллами
- Поддержка пагинации (page, limit)
- Фильтрация по заведениям (venueCode)
- Фильтрация по типу операций (type: earned, spent, expired, bonus)
- Фильтрация по датам (startDate, endDate)
- Требует аутентификации

ЭНДПОИНТЫ ДЛЯ ЗАВЕДЕНИЙ:
========================

POST /api/venue/create
- Создание нового заведения
- Принимает настройки удвоенных баллов (doublePointsHours)
- Возвращает уникальный 3-символьный код заведения

POST /api/venue/generate-code
- Генерация 6-значного кода покупки (для кассира)
- Принимает venueCode и purchaseAmount
- Автоматически учитывает часы удвоенных баллов
- Возвращает код с временем жизни 20 секунд и информацию о множителе

GET /api/venue/:venueCode
- Получить информацию о заведении
- Возвращает данные заведения, настройки баллов и часы удвоенных баллов
- Показывает текущий статус удвоенных баллов

GET /api/venue/:venueCode/stats
- Статистика заведения
- Возвращает количество клиентов и начисленных баллов

GET /api/venue/:venueCode/balance
- Баланс заведения
- Возвращает выданные, потраченные баллы и текущий баланс

GET /api/venue/:venueCode/balance/weekly
- Еженедельный отчет по балансу
- Статистика по дням недели

GET /api/venue/:venueCode/balance/hourly
- Почасовой отчет по балансу
- Статистика по часам дня

АДМИНИСТРАТИВНЫЕ ЭНДПОИНТЫ:
============================

GET /api/admin/venues/balance
- Общий баланс всех заведений
- Поддержка пагинации и сортировки

GET /api/admin/venues/top-earners
- Топ заведений по выданным баллам
- Фильтрация по периодам (week, month, all)

GET /api/admin/venues/top-spenders
- Топ заведений по потраченным баллам
- Фильтрация по периодам (week, month, all)

GET /api/admin/transactions/summary
- Общая статистика транзакций
- Сводка по типам операций и периодам

ЭНДПОИНТЫ ДЛЯ МЕНЮ:
====================

GET /api/menu/:venueCode
- Получить меню заведения
- Фильтрация по категориям
- Сортировка по различным параметрам

GET /api/menu/:venueCode/categories
- Получить список категорий меню заведения

POST /api/menu/:venueCode/item
- Создать товар в меню (для заведения)
- Принимает данные о товаре и его стоимости в баллах

PUT /api/menu/item/:itemId
- Обновить товар в меню
- Изменение цены, описания, доступности

DELETE /api/menu/item/:itemId
- Удалить товар из меню
- Деактивация вместо физического удаления

POST /api/menu/item/:itemId/purchase
- Купить товар за баллы
- Требует аутентификации
- Автоматическое списание баллов

GET /api/menu/purchases
- История покупок пользователя
- Фильтрация по заведениям, статусам, датам
- Требует аутентификации

ЭНДПОИНТЫ ДЛЯ ЗАКАЗОВ:
========================

POST /api/orders/create
- Создать заказ в заведении
- Указание имени клиента для выдачи
- Выбор типа оплаты (общие или индивидуальные баллы)
- Требует аутентификации

GET /api/orders/venue/:venueCode
- Получить заказы заведения (для кассира)
- Фильтрация по статусам и датам
- Отображение имени клиента и деталей заказа

PUT /api/orders/:orderId/status
- Обновить статус заказа (для кассира)
- Статусы: confirmed, preparing, ready, completed, cancelled

GET /api/orders/my
- Мои заказы (для пользователя)
- Фильтрация по заведениям, статусам, датам
- Требует аутентификации

GET /api/orders/venue-balances
- Индивидуальные балансы по заведениям
- Статус клиента в каждом заведении
- Требует аутентификации

ЭНДПОИНТЫ РЕФЕРАЛЬНОЙ СИСТЕМЫ:
================================

POST /api/user/register-with-referral
- Регистрация пользователя с реферальным кодом
- Автоматическое начисление бонуса рефереру

POST /api/user/claim-daily-bonus
- Получить ежедневный бонус за вход в приложение
- Система серий (streak) для мотивации
- Требует аутентификации

GET /api/user/referral-stats
- Получить статистику рефералов пользователя
- Количество приглашенных и заработанных бонусов
- Требует аутентификации

ЭНДПОИНТЫ ДЛЯ УВЕДОМЛЕНИЙ:
============================

POST /api/notifications/create
- Создать уведомление для пользователей
- Фильтрация по заведениям и статусам клиентов
- Поддержка различных типов уведомлений

POST /api/notifications/send/:notificationId
- Отправить уведомление пользователям
- Автоматическая фильтрация по посещенным заведениям

GET /api/notifications
- Получить список уведомлений
- Фильтрация по типам, статусам, заведениям

POST /api/notifications/discounts/create
- Создать скидку/акцию для заведения
- Различные типы скидок: процент, фиксированная сумма, подарки

GET /api/notifications/discounts/:venueCode
- Получить активные скидки заведения
- Фильтрация по категориям товаров

PUT /api/notifications/:notificationId/cancel
- Отменить запланированное уведомление

ЭНДПОИНТЫ ДЛЯ СГОРАНИЯ БАЛЛОВ:
================================

POST /api/expiry/process
- Запустить процесс автоматического сгорания баллов
- Для использования в cron job

GET /api/expiry/stats
- Получить статистику сгорания баллов
- Фильтрация по заведениям

GET /api/expiry/user/:userId
- Получить информацию о сгорающих баллах пользователя
- Детализация по заведениям

POST /api/expiry/manual/:userId
- Ручное сгорание баллов пользователя
- Для административных целей

ЭНДПОИНТЫ АДМИН ПАНЕЛИ:
=========================

GET /api/admin/dashboard
- Общая статистика системы для админ панели
- Количество пользователей, заведений, транзакций
- Статистика за последние 30 дней
- Топ заведений по выданным баллам

СТРУКТУРА ПРОЕКТА:
==================
src/
├── app.js              # Главный файл приложения
├── models/
│   ├── User.js         # Модель пользователя с реферальной системой и ежедневными бонусами
│   ├── Venue.js        # Модель заведения с настраиваемыми сроками жизни баллов
│   ├── PurchaseCode.js # Модель кода покупки (6 символов)
│   ├── PointsTransaction.js # Модель транзакций баллов с привязкой к заведениям
│   ├── VenueBalance.js # Модель баланса баллов по заведениям
│   ├── MenuItem.js     # Модель товаров меню заведений
│   ├── Purchase.js     # Модель покупок товаров за баллы
│   ├── UserVenueBalance.js # Модель индивидуальных баллов пользователя по заведениям
│   ├── Order.js        # Модель заказов с уведомлениями для кассира
│   ├── Notification.js # Модель уведомлений с фильтрацией по заведениям
│   ├── Discount.js     # Модель скидок и акций
│   └── Referral.js     # Модель реферальной системы
├── routes/
│   ├── user.js         # Маршруты для пользователя
│   ├── venue.js        # Маршруты для заведений
│   ├── admin.js        # Административные маршруты
│   ├── menu.js         # Маршруты для меню и покупок
│   ├── orders.js       # Маршруты для заказов
│   ├── notifications.js # Маршруты для уведомлений и скидок
│   └── expiry.js       # Маршруты для сгорания баллов
├── services/
│   ├── CodeService.js  # Сервис для работы с кодами и транзакциями
│   ├── TelegramService.js # Сервис для работы с Telegram ботом
│   └── PointsExpiryService.js # Сервис для автоматического сгорания баллов
└── middleware/
    └── auth.js         # Middleware для аутентификации

ОСОБЕННОСТИ СИСТЕМЫ БАЛЛОВ:
============================
- Баланс баллов пользователя
- Настраиваемые сроки жизни баллов для каждого заведения (от 2 недель)
- Автоматическое сгорание баллов по истечении срока
- Уведомления о скором сгорании баллов
- Отслеживание общего количества заработанных/потраченных баллов
- Методы для получения информации о ближайшем сгорании

СИСТЕМА 6-ЗНАЧНЫХ КОДОВ:
=========================
- Первые 3 символа: уникальный код заведения
- Последние 3 символа: случайно сгенерированные
- Время жизни кода: 20 секунд
- Автоматическое начисление баллов при использовании
- Защита от повторного использования
- Отслеживание статистики по заведениям

СИСТЕМА УДВОЕННЫХ БАЛЛОВ:
==========================
- Настройка часов удвоенных баллов для каждого заведения
- Поддержка разных дней недели и временных интервалов
- Автоматический расчет множителя при генерации кода
- Отображение текущего статуса удвоенных баллов

СИСТЕМА ТРАНЗАКЦИЙ:
====================
- Полное отслеживание всех операций с баллами
- Привязка каждой транзакции к конкретному заведению
- Типы операций: earned (заработано), spent (потрачено), expired (сгорело), bonus (бонус)
- Фильтрация истории по заведениям, типам операций и датам
- Детальная информация о каждой операции (сумма покупки, множитель, метаданные)

СИСТЕМА УЧЕТА БАЛЛОВ ПО ЗАВЕДЕНИЯМ:
====================================
- Отдельный баланс для каждого заведения
- Учет выданных и потраченных баллов
- Статистика по дням недели и часам
- Подсчет уникальных клиентов
- Аналитика по типам операций
- Административные отчеты и топы заведений

СИСТЕМА МЕНЮ И ПОКУПОК:
=========================
- Создание меню товаров для каждого заведения
- Стоимость товаров в баллах
- Категории товаров и теги для поиска
- Опции товаров с модификаторами цены
- Управление остатками товаров
- Система покупок с автоматическим списанием баллов
- История покупок пользователей
- Статистика продаж по товарам
- Статусы покупок: pending, confirmed, completed, cancelled

СИСТЕМА ЗАКАЗОВ И ИНДИВИДУАЛЬНЫХ БАЛЛОВ:
==========================================
- Создание заказов с указанием имени клиента
- Выбор типа оплаты: общие или индивидуальные баллы заведения
- Индивидуальные балансы пользователей по каждому заведению
- Статусы клиентов: new, regular, vip с различными привилегиями
- Система уведомлений для кассира с деталями заказа
- Полный жизненный цикл заказа: pending → confirmed → preparing → ready → completed
- Возможность отмены заказа с возвратом баллов
- Статистика посещений и лояльности клиентов

TELEGRAM БОТ И СИСТЕМА УВЕДОМЛЕНИЙ:
====================================
- Telegram бот для отправки уведомлений пользователям
- Фильтрация уведомлений по посещенным заведениям
- Различные типы уведомлений: скидки, акции, новости, системные
- Система скидок и акций с различными типами
- Автоматические уведомления о статусе заказов
- Уведомления кассиру о новых заказах
- Уведомления о скором сгорании баллов
- Планирование и отмена уведомлений
- Статистика доставки уведомлений

СИСТЕМА НАСТРАИВАЕМЫХ СРОКОВ ЖИЗНИ БАЛЛОВ:
============================================
- Каждое заведение настраивает срок жизни баллов (от 2 недель до 2 лет)
- Автоматическое сгорание как общих, так и индивидуальных баллов заведений
- Уведомления пользователям о скором сгорании общих и индивидуальных баллов
- Статистика сгорания баллов по заведениям с разделением по типам
- Ручное управление сгоранием для администраторов
- Отслеживание сгорающих баллов по заведениям и типам

АДМИН ПАНЕЛЬ:
==============
- Общая статистика системы: пользователи, заведения, транзакции
- Статистика за последние 30 дней
- Топ заведений по выданным баллам
- Общая сумма заработанных, потраченных и сгоревших баллов
- Сетевой баланс баллов в системе

РЕФЕРАЛЬНАЯ СИСТЕМА И ЕЖЕДНЕВНЫЕ БОНУСЫ:
==========================================
- Уникальные 8-символьные реферальные коды для каждого пользователя
- Автоматическое начисление 1 балла за приглашение друга
- Ежедневный бонус 1 балл за первый вход в приложение
- Система серий (streak) для мотивации ежедневного использования
- Отслеживание статистики рефералов и заработанных бонусов
- Топ рефереров по количеству приглашенных пользователей

ИСТОРИЯ ИЗМЕНЕНИЙ:
==================
11.10.2025 - Создание проекта и базовой структуры
11.10.2025 - Добавлено правило документирования всех изменений в README
11.10.2025 - Создана базовая структура бэкенда для Telegram Mini App
11.10.2025 - Реализованы эндпоинты для пользователя:
           - Модель User с системой баллов и сгорания
           - Аутентификация через JWT
           - Эндпоинты: profile, register, scan-qr, points-history
           - Middleware для защиты маршрутов
11.10.2025 - Реализована система 6-значных кодов:
           - Модель Venue с уникальными кодами заведений
           - Модель PurchaseCode с временем жизни 20 секунд
           - Сервис CodeService для генерации и валидации кодов
           - Эндпоинты для заведений: create, generate-code, stats
           - Обновлены пользовательские эндпоинты: use-code, check-code
11.10.2025 - Добавлена система отслеживания транзакций и удвоенных баллов:
           - Модель PointsTransaction для полного отслеживания операций
           - Система часов удвоенных баллов в модели Venue
           - Автоматический расчет множителей при генерации кодов
           - Расширенная история операций с фильтрацией по заведениям
           - Детальная информация о каждой транзакции с метаданными
11.10.2025 - Реализован учет баллов по заведениям:
           - Модель VenueBalance для ведения баланса каждого заведения
           - Автоматическое обновление статистики при транзакциях
           - Отчеты по дням недели и часам для анализа активности
           - Административные эндпоинты для мониторинга системы
           - Топы заведений по выданным и потраченным баллам
11.10.2025 - Реализована система меню и покупок:
           - Модель MenuItem для товаров меню заведений
           - Модель Purchase для покупок товаров за баллы
           - Полное управление меню: создание, обновление, удаление товаров
           - Система покупок с автоматическим списанием баллов
           - История покупок с фильтрацией и статусами
           - Статистика продаж и управление остатками товаров
11.10.2025 - Реализована система заказов и индивидуальных баллов:
           - Модель Order для заказов с уведомлениями кассиру
           - Модель UserVenueBalance для индивидуальных баллов по заведениям
           - Создание заказов с указанием имени клиента
           - Выбор типа оплаты: общие или индивидуальные баллы
           - Статусы клиентов и система лояльности
           - Полный жизненный цикл заказа с уведомлениями для кассира
11.10.2025 - Реализован Telegram бот и система уведомлений:
           - TelegramService для отправки уведомлений пользователям
           - Модель Notification с фильтрацией по посещенным заведениям
           - Модель Discount для скидок и акций различных типов
           - Автоматические уведомления о статусе заказов
           - Уведомления кассиру о новых заказах
           - Система планирования и отмены уведомлений
11.10.2025 - Реализована система настраиваемых сроков жизни баллов:
           - Настройка срока жизни баллов для каждого заведения (от 2 недель)
           - PointsExpiryService для автоматического сгорания баллов
           - Уведомления пользователям о скором сгорании баллов
           - Статистика сгорания баллов и ручное управление
           - Обновленная модель User с привязкой баллов к заведениям
11.10.2025 - Обновлена система сгорания баллов для поддержки двойного сгорания:
           - Сгорание как общих баллов пользователя, так и индивидуальных баллов заведений
           - Раздельные уведомления о сгорании общих и индивидуальных баллов
           - Обновленная статистика с разделением по типам баллов
           - Методы сгорания в UserVenueBalance для индивидуальных баллов
           - Ручное управление сгоранием для обоих типов баллов
11.10.2025 - Реализована админ панель с общей статистикой системы:
           - Эндпоинт /api/admin/dashboard для получения общей статистики
           - Количество пользователей, заведений, транзакций
           - Статистика за последние 30 дней
           - Топ заведений по выданным баллам
           - Общая сумма баллов и сетевой баланс
11.10.2025 - Реализована реферальная система и ежедневные бонусы:
           - Уникальные 8-символьные реферальные коды для каждого пользователя
           - Автоматическое начисление 1 балла за приглашение друга
           - Ежедневный бонус 1 балл за первый вход в приложение
           - Система серий (streak) для мотивации ежедневного использования
           - Модель Referral для отслеживания рефералов
           - Статистика рефералов и топ рефереров


